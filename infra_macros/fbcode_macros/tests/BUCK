load(
    "@fbcode_macros//tests:skylark_integration_test.bzl",
    "skylark_integration_test",
    "skylark_integration_tests",
    "targets_to_resource_paths",
)
load("@fbsource//tools/build_defs:fb_native_wrapper.bzl", "fb_native")

BUILD_DEFS = [
    "bazel_skylib//:lib.bzl",
    "bazel_skylib//lib:collections.bzl",
    "bazel_skylib//lib:dicts.bzl",
    "bazel_skylib//lib:new_sets.bzl",
    "bazel_skylib//lib:partial.bzl",
    "bazel_skylib//lib:paths.bzl",
    "bazel_skylib//lib:selects.bzl",
    "bazel_skylib//lib:sets.bzl",
    "bazel_skylib//lib:shell.bzl",
    "bazel_skylib//lib:structs.bzl",
    "bazel_skylib//lib:types.bzl",
    "bazel_skylib//lib:versions.bzl",
    "fbcode_macros//build_defs/config:read_configs.bzl",
    "fbcode_macros//build_defs/lib:allocators.bzl",
    "fbcode_macros//build_defs/lib:build_info.bzl",
    "fbcode_macros//build_defs/lib:build_mode.bzl",
    "fbcode_macros//build_defs/lib:common_paths.bzl",
    "fbcode_macros//build_defs/lib:copy_rule.bzl",
    "fbcode_macros//build_defs/lib:core_tools.bzl",
    "fbcode_macros//build_defs/lib:cpp_common.bzl",
    "fbcode_macros//build_defs/lib:cpp_flags.bzl",
    "fbcode_macros//build_defs/lib:cuda.bzl",
    "fbcode_macros//build_defs/lib:d_common.bzl",
    "fbcode_macros//build_defs/lib:default_platform.bzl",
    "fbcode_macros//build_defs/lib:global_compiler.bzl",
    "fbcode_macros//build_defs/lib:go_common.bzl",
    "fbcode_macros//build_defs/lib:haskell_common.bzl",
    "fbcode_macros//build_defs/lib:haskell_rules.bzl",
    "fbcode_macros//build_defs/lib:java_common.bzl",
    "fbcode_macros//build_defs/lib:js_common.bzl",
    "fbcode_macros//build_defs/lib:label_utils.bzl",
    "fbcode_macros//build_defs/lib:lua_common.bzl",
    "fbcode_macros//build_defs/lib:merge_tree.bzl",
    "fbcode_macros//build_defs/lib:modules.bzl",
    "fbcode_macros//build_defs/lib:ocaml_common.bzl",
    "fbcode_macros//build_defs/lib:python_typing.bzl",
    "fbcode_macros//build_defs/lib:python_versioning.bzl",
    "fbcode_macros//build_defs/lib:rule_target_types.bzl",
    "fbcode_macros//build_defs/lib:rust_common.bzl",
    "fbcode_macros//build_defs/lib:shell.bzl",
    "fbcode_macros//build_defs/lib:src_and_dep_helpers.bzl",
    "fbcode_macros//build_defs/lib:string_macros.bzl",
    "fbcode_macros//build_defs/lib:target_utils.bzl",
    "fbcode_macros//build_defs/lib:third_party.bzl",
    "fbcode_macros//build_defs/lib:visibility.bzl",
    "fbcode_macros//build_defs:allocator_targets.bzl",
    "fbcode_macros//build_defs:antlr3_srcs.bzl",
    "fbcode_macros//build_defs:antlr4_srcs.bzl",
    "fbcode_macros//build_defs:auto_headers.bzl",
    "fbcode_macros//build_defs:auto_pch_blacklist.bzl",
    "fbcode_macros//build_defs:build_mode_overrides.bzl",
    "fbcode_macros//build_defs:cgo_library.bzl",
    "fbcode_macros//build_defs:compiler.bzl",
    "fbcode_macros//build_defs:config.bzl",
    "fbcode_macros//build_defs:coverage.bzl",
    "fbcode_macros//build_defs:cpp_benchmark.bzl",
    "fbcode_macros//build_defs:cpp_binary.bzl",
    "fbcode_macros//build_defs:cpp_java_extension.bzl",
    "fbcode_macros//build_defs:cpp_jvm_library.bzl",
    "fbcode_macros//build_defs:cpp_library.bzl",
    "fbcode_macros//build_defs:cpp_library_external.bzl",
    "fbcode_macros//build_defs:cpp_library_external_custom.bzl",
    "fbcode_macros//build_defs:cpp_lua_extension.bzl",
    "fbcode_macros//build_defs:cpp_lua_main_module.bzl",
    "fbcode_macros//build_defs:cpp_module_external.bzl",
    "fbcode_macros//build_defs:cpp_node_extension.bzl",
    "fbcode_macros//build_defs:cpp_precompiled_header.bzl",
    "fbcode_macros//build_defs:cpp_python_extension.bzl",
    "fbcode_macros//build_defs:cpp_unittest.bzl",
    "fbcode_macros//build_defs:create_build_mode.bzl",
    "fbcode_macros//build_defs:custom_rule.bzl",
    "fbcode_macros//build_defs:custom_unittest.bzl",
    "fbcode_macros//build_defs:d_binary.bzl",
    "fbcode_macros//build_defs:d_library_external.bzl",
    "fbcode_macros//build_defs:d_library.bzl",
    "fbcode_macros//build_defs:d_unittest.bzl",
    "fbcode_macros//build_defs:dewey_artifact.bzl",
    "fbcode_macros//build_defs:discard.bzl",
    "fbcode_macros//build_defs:export_files.bzl",
    "fbcode_macros//build_defs:go_binary.bzl",
    "fbcode_macros//build_defs:go_bindgen_library.bzl",
    "fbcode_macros//build_defs:go_external_library.bzl",
    "fbcode_macros//build_defs:go_external_library.bzl",
    "fbcode_macros//build_defs:go_library.bzl",
    "fbcode_macros//build_defs:go_unittest.bzl",
    "fbcode_macros//build_defs:haskell_external_library.bzl",
    "fbcode_macros//build_defs:haskell_binary.bzl",
    "fbcode_macros//build_defs:haskell_haddock.bzl",
    "fbcode_macros//build_defs:haskell_ghci.bzl",
    "fbcode_macros//build_defs:haskell_library.bzl",
    "fbcode_macros//build_defs:haskell_unittest.bzl",
    "fbcode_macros//build_defs:java_binary.bzl",
    "fbcode_macros//build_defs:java_library.bzl",
    "fbcode_macros//build_defs:java_shaded_jar.bzl",
    "fbcode_macros//build_defs:java_test.bzl",
    "fbcode_macros//build_defs:js_executable.bzl",
    "fbcode_macros//build_defs:js_node_module_external.bzl",
    "fbcode_macros//build_defs:js_npm_module.bzl",
    "fbcode_macros//build_defs:lex.bzl",
    "fbcode_macros//build_defs:lex.bzl",
    "fbcode_macros//build_defs:lua_binary.bzl",
    "fbcode_macros//build_defs:lua_library.bzl",
    "fbcode_macros//build_defs:lua_unittest.bzl",
    "fbcode_macros//build_defs:missing_tp2_project.bzl",
    "fbcode_macros//build_defs:native_rules.bzl",
    "fbcode_macros//build_defs:ocaml_binary.bzl",
    "fbcode_macros//build_defs:ocaml_external_library.bzl",
    "fbcode_macros//build_defs:ocaml_library.bzl",
    "fbcode_macros//build_defs:paths_config.bzl",
    "fbcode_macros//build_defs:platform_overrides.bzl",
    "fbcode_macros//build_defs:platform_utils.bzl",
    "fbcode_macros//build_defs:prebuilt_jar.bzl",
    "fbcode_macros//build_defs:python_wheel.bzl",
    "fbcode_macros//build_defs:rust_binary.bzl",
    "fbcode_macros//build_defs:rust_bindgen_library.bzl",
    "fbcode_macros//build_defs:rust_external_library.bzl",
    "fbcode_macros//build_defs:rust_library.bzl",
    "fbcode_macros//build_defs:rust_unittest.bzl",
    "fbcode_macros//build_defs:sanitizers.bzl",
    "fbcode_macros//build_defs:scala_library.bzl",
    "fbcode_macros//build_defs:scala_test.bzl",
    "fbcode_macros//build_defs:third_party_config.bzl",
    "fbcode_macros//build_defs:visibility_exceptions.bzl",
    "fbcode_macros//build_defs:yacc.bzl",
    "fbcode_macros//tools:BUCK",
    "fbcode_macros//tools:get_platform.py",
    "fbsource//tools/build_defs:buckconfig.bzl",
    "fbsource//tools/build_defs:copy_defs.bzl",
    "fbsource//tools/build_defs:fb_native_wrapper.bzl",
    "fbsource//tools/build_defs:host_arch.bzl",
    "fbsource//tools/build_defs:host_os.bzl",
    "fbsource//tools/build_defs:sanitizers.bzl",
    "fbsource//tools/build_defs:translate_to_fbsource_paths.bzl",
    "fbsource//tools/build_defs:type_defs.bzl",
    "xplat//tools/build_defs:type_defs.bzl",
]

TESTS = [
    "cgo_library_test",
    "compiler_test",
    "config_test",
    "coverage_test",
    "cpp_benchmark_test",
    "cpp_binary_test",
    "cpp_java_extension_test",
    "cpp_jvm_library_test",
    "cpp_library_external_test",
    "cpp_library_external_custom_test",
    "cpp_library_test",
    "cpp_lua_extension_test",
    "cpp_lua_main_module_test",
    "cpp_module_external_test",
    "cpp_node_extension_test",
    "cpp_precompiled_header_test",
    "cpp_python_extension_test",
    "cpp_unittest_test",
    "custom_unittest_test",
    "d_binary_test",
    "d_library_test",
    "d_unittest_test",
    "discard_test",
    "export_files_test",
    "go_binary_test",
    "go_bindgen_library_test",
    "go_external_library_test",
    "go_library_test",
    "go_unittest_test",
    "haskell_external_library_test",
    "haskell_binary_test",
    "haskell_haddock_test",
    "haskell_ghci_test",
    "haskell_library_test",
    "haskell_unittest_test",
    "js_executable_test",
    "js_node_module_external_test",
    "js_npm_module_test",
    "lex_test",
    "lua_binary_test",
    "lua_library_test",
    "lua_unittest_test",
    "missing_tp2_project_test",
    "native_rules_test",
    "ocaml_binary_test",
    "ocaml_external_library_test",
    "ocaml_library_test",
    "platform_utils_test",
    "python_wheel_test",
    "rust_binary_test",
    "rust_bindgen_library_test",
    "rust_external_library_test",
    "rust_library_test",
    "rust_unittest_test",
    "sanitizers_test",
    "third_party_config_test",
    "yacc_test",
]

UTIL_DEFS = targets_to_resource_paths(BUILD_DEFS)

UTIL_DEFS[".buckversion"] = ":buckversion"

# This should change whenever the buck version meaningfully changes
fb_native.genrule(
    name = "buckversion",
    srcs = ["fbcode_macros//:buckversion"],
    out = "buckversion",
    cmd = "buck --version | awk {'print $3'} > $OUT",
)

fb_native.python_library(
    name = "utils",
    srcs = [
        "utils.py",
    ],
    resources = UTIL_DEFS,
    visibility = ["PUBLIC"],
    deps = [
        "fbcode_macros//tests/third-party/future:future",
        "fbcode_macros//tests/third-party/setuptools:setuptools",
        "fbcode_macros//tests/third-party/six:six",
    ],
)

skylark_integration_tests(TESTS)

skylark_integration_test(
    name = "custom_rule_test",
    srcs = ["custom_rule_test.py"],
    resources = glob(["testdata/custom_rule/*"]),
)

skylark_integration_test(
    name = "utils_test",
    srcs = ["utils_test.py"],
    resources = ["testdata/utils_test/sample.txt"],
)
